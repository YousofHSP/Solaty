@page "/auth/login"
@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using Microsoft.AspNetCore.Components.Authorization
@using WebClient.Components.Layout
@using WebClient.Services.Api
@using WebClient.Services.Common
@using WebClient.Services.Components
@inject AuthService AuthService
@inject ToastService ToastService
@inject NavigationManager NavManager
@inject IJSRuntime Js
@inject IBaseService BaseService
@inject IHttpClientFactory ClientFactory
@inject HttpClient SelfHttp
@rendermode InteractiveServer

<link rel="stylesheet" href="css/auth-login.css" />
<link rel="stylesheet" href="css/font.css" />

<div class="register-page">

    <!-- ستون راست -->
    <section class="form-col">
        <div class="form-wrap">
            <img class="decor decor-left" src="images/gift_front 2.svg" />
            <img class="decor decor-top-right" src="images/Rectangle 2.svg" />
            <img class="decor decor-bottom-left" src="images/Rectangle 3.svg" />

            <div class="m-hero mobile-only">
                <img class="m-hero__logo" src="images/Group 1.svg" />
                <h1 class="m-hero__title">لاولایف</h1>
                <p class="m-hero__subtitle">سامانه مدیریت روابط زوجین</p>
            </div>

            <article class="form-card" role="form">

                <header class="form-head desktop-only">
                    <h2 class="form-title">ورود به لاولایف</h2>
                    <p class="form-subtitle">لطفاً اطلاعات خود را وارد کنید</p>
                </header>

                <!-- تلفن / نام کاربری -->
                <label class="field">
                    <span class="field__icon">
                        <img src="images/Phone Rounded.svg" />
                    </span>
                    <input class="field__input"
                           type="text"
                           placeholder="نام کاربری / تلفن"
                           @bind="_userName" />
                </label>

                <!-- رمز عبور -->
                <label class="field">
                    <span class="field__icon">
                        <img src="images/Lock Password Unlocked.svg" />
                    </span>
                    <img class="rp-eye" src="images/Eye.svg" />
                    <input class="field__input"
                           type="password"
                           placeholder="کلمه عبور"
                           @bind="_password" />
                </label>

                <div class="links-row">
                    <a class="link-otp">ورود با کد یکبار مصرف</a>
                    <a class="link-muted" @onclick="GoToForgotPassword">کلمه عبور خود را فراموش کردم</a>
                </div>

                <!-- دکمه ورود -->
                <button class="btn-primary" type="button" @onclick="LoginAsync" disabled="@_isBusy">
                    @if (_isBusy)
                    {
                        <span>لطفاً صبر کنید...</span>
                    }
                    else
                    {
                        <span>ورود به حساب لاولایف</span>
                    }
                </button>

                <!-- سوشال -->
                <div class="or-social">
                    <span class="or-line"></span>
                    <span class="or-text">یا ورود از طریق</span>
                    <span class="or-line"></span>
                </div>

                <div class="social-row">
                    <button class="social-btn"><img src="images/Facebook.svg" /></button>
                    <button class="social-btn"><img src="images/Apple.svg" /></button>
                    <button class="social-btn">
                        <img src="images/Google.svg" />
                        <p class="text-Google mobile-only">حساب گوگل</p>
                    </button>
                </div>

                <p class="bottom-cta">
                    حساب کاربری نداری؟
                    <a class="link-accent">ساخت حساب</a>
                </p>

                <p class="app-version mobile-only">V 1.0.0.2</p>

            </article>
        </div>
    </section>

    <!-- ستون چپ -->
    <section class="hero">
        <div class="hero-text">
            <span class="hero-divider"></span>
            <h1 class="hero-title">دیت لند</h1>
            <p class="hero-desc">
                بهترین لوکیشن‌های خاص برای قرارهای عاشقانه شما
            </p>

            <div class="hero-pager">
                <button class="pager-arrow is-left">→</button>
                <div class="dots">
                    <span class="dot is-active"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
                <button class="pager-arrow is-right">←</button>
            </div>
        </div>

        <div class="hero-illustration">
            <img src="images/7 1.svg" />
        </div>
    </section>
</div>

@code {
    private string _userName = "";
    private string _password = "";
    private string _captchaToken = "";
    private bool _isBusy;
    private bool _isLoadingCaptcha;
    private bool _isHumanVerified;
    string? returnUrl;

    protected override void OnInitialized()
    {
        var uri = new Uri(NavManager.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue(nameof(returnUrl), out var value))
        {
            returnUrl = value;
        }

        SelfHttp.BaseAddress = new Uri(NavManager.BaseUri);
    }

    private async Task LoginAsync()
    {
        try
        {
            // اگر کپچا می‌خواهی → نذار حذف کنم
            if (!_isHumanVerified || string.IsNullOrEmpty(_captchaToken))
            {
                ToastService.ShowError("لطفاً کپچا را تکمیل کنید.");
                return;
            }

            _isBusy = true;

            var result = await AuthService.LoginAsync(_userName, _password, _captchaToken);

            if (result)
            {
                NavManager.NavigateTo($"/auth/SignIn?jwtToken={AuthService.Token}", forceLoad: true);
            }
            else
            {
                _isBusy = false;
                ToastService.ShowError("نام کاربری یا رمز عبور اشتباه است.");
            }
        }
        catch
        {
            ToastService.ShowError("خطا در ورود. لطفاً دوباره تلاش کنید.");
            _isBusy = false;
        }
    }

    private async Task HandleCaptchaClick()
    {
        if (_isLoadingCaptcha || _isHumanVerified)
            return;

        _isLoadingCaptcha = true;
        StateHasChanged();

        await Task.Delay(1500);

        _captchaToken = Guid.NewGuid().ToString("N");
        _isHumanVerified = true;
        _isLoadingCaptcha = false;

        StateHasChanged();
    }

    private async Task GoToForgotPassword()
    {
        await Js.InvokeVoidAsync("eval", "document.body.classList.add('page-transition');");
        await Task.Delay(600);
        NavManager.NavigateTo("/Auth/ForgotPassword");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Js.InvokeVoidAsync("localStorage.clear");
        }
    }
}
